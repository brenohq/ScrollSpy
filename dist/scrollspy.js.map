{"version":3,"file":"scrollspy.js","sources":["../src/scrollspy.ts"],"sourcesContent":["/*\n * Copyright (c) 2016, Globo.com (https://github.com/globocom)\n *\n * License: MIT\n */\n\nexport interface ScrollSpyItemOptions {\n  el: HTMLElement;\n  callback: () => void;\n  offset?: number;\n  reference?: ScrollSpyItemReference;\n}\n\nexport type ScrollSpyItemReference = \"top\" | \"bottom\";\n\nexport type ScrollSpyCallback = () => void;\n\nexport interface ScrollSpyItem extends ScrollSpyItemOptions {\n  offset: number;\n  reference: ScrollSpyItemReference;\n  pos: number;\n}\n\nlet items: ScrollSpyItem[] = [];\nlet winHeight: number;\nlet docHeight: number;\n\nexport function clean(): void {\n  items = [];\n}\n\nexport function getItems(): readonly (Readonly<ScrollSpyItem>)[] {\n  return items.map(i => i);\n}\n\nexport function add(param: ScrollSpyItemOptions): void {\n  if (!param.el) {\n    throw new Error(\"[@globocom/scrollspy] item.el is required\");\n  }\n  const item: ScrollSpyItem = Object.assign(\n    { offset: 200, reference: \"top\", pos: 0 },\n    param\n  );\n  item.pos = getElementPos(item);\n\n  const index = items.findIndex(i => i.pos > item.pos);\n\n  items.splice(index === -1 ? items.length : index, 0, item);\n\n  if (items.length === 1) {\n    setDefaultVariables();\n    startListener();\n  }\n  checkVisibleItems();\n}\n\nexport function debug(): ScrollSpyItem[] {\n  items.forEach((item, i) => {\n    const color = i % 2 ? \"red\" : \"blue\";\n    const border = `2px dashed ${color}`;\n    const nodeHtml = document.createElement(\"div\");\n    const css = [\n      `top: ${item.pos};`,\n      \"width: 100%;\",\n      \"position: absolute;\",\n      `border-top: ${border};`\n    ].join(\"\");\n\n    item.el.style.border = border;\n\n    nodeHtml.className = \"debug-line\";\n    nodeHtml.setAttribute(\"style\", css);\n    document.body.appendChild(nodeHtml);\n  });\n  return items;\n}\n\nfunction throttle(callback: ScrollSpyCallback): () => void {\n  let idle = true;\n  return () => {\n    if (idle) {\n      callback();\n      idle = false;\n      setTimeout(() => (idle = true), 150);\n    }\n  };\n}\n\nfunction getElementPos(item: ScrollSpyItem): number {\n  const top = getScrollY();\n  const boundClient = item.el.getBoundingClientRect();\n  return boundClient[item.reference] + top - item.offset;\n}\n\nfunction getScrollY(): number {\n  if (typeof pageYOffset !== \"undefined\") {\n    return pageYOffset;\n  } else {\n    let doc = document.documentElement;\n    doc = doc.clientHeight ? doc : document.body;\n    return doc.scrollTop;\n  }\n}\n\nfunction onResize(): void {\n  throttle(() => {\n    if (winHeight !== window.innerHeight) {\n      resetElementPosition();\n    }\n  });\n}\n\nfunction onScroll(): void {\n  checkDocumentHeight();\n  checkVisibleItems();\n}\n\nfunction startListener(): void {\n  window.addEventListener(\"scroll\", throttle(onScroll));\n  window.addEventListener(\"resize\", throttle(onResize));\n}\n\nfunction stopListeners(): void {\n  window.removeEventListener(\"scroll\", throttle(onScroll));\n  window.removeEventListener(\"resize\", throttle(onResize));\n}\n\nfunction resetElementPosition(): void {\n  winHeight = window.innerHeight;\n  for (const item of items) {\n    item.pos = getElementPos(item);\n  }\n  checkVisibleItems();\n}\n\nfunction setDefaultVariables(): void {\n  winHeight = window.innerHeight;\n  docHeight = document.body ? document.body.offsetHeight : 0;\n}\n\nfunction checkDocumentHeight(): void {\n  const currentDocHeight = document.body.offsetHeight;\n  if (docHeight !== currentDocHeight) {\n    docHeight = currentDocHeight;\n    resetElementPosition();\n  }\n}\n\nfunction checkVisibleItems(): void {\n  const currentPos = getScrollY();\n  const currentPosOffset = winHeight + currentPos;\n  for (const item of items) {\n    if (currentPosOffset >= item.pos) {\n      if (item.callback) {\n        item.callback();\n      }\n      items.shift();\n    } else {\n      break;\n    }\n  }\n  if (!items.length) {\n    stopListeners();\n  }\n}\n"],"names":[],"mappings":";;;;;;IAAA;;;;;IAuBA,IAAI,KAAK,GAAoB,EAAE,CAAC;IAChC,IAAI,SAAiB,CAAC;IACtB,IAAI,SAAiB,CAAC;AAEtB,aAAgB,KAAK;QACnB,KAAK,GAAG,EAAE,CAAC;IACb,CAAC;AAED,aAAgB,QAAQ;QACtB,OAAO,KAAK,CAAC,GAAG,CAAC,UAAA,CAAC,IAAI,OAAA,CAAC,GAAA,CAAC,CAAC;IAC3B,CAAC;AAED,aAAgB,GAAG,CAAC,KAA2B;QAC7C,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE;YACb,MAAM,IAAI,KAAK,CAAC,2CAA2C,CAAC,CAAC;SAC9D;QACD,IAAM,IAAI,GAAkB,MAAM,CAAC,MAAM,CACvC,EAAE,MAAM,EAAE,GAAG,EAAE,SAAS,EAAE,KAAK,EAAE,GAAG,EAAE,CAAC,EAAE,EACzC,KAAK,CACN,CAAC;QACF,IAAI,CAAC,GAAG,GAAG,aAAa,CAAC,IAAI,CAAC,CAAC;QAE/B,IAAM,KAAK,GAAG,KAAK,CAAC,SAAS,CAAC,UAAA,CAAC,IAAI,OAAA,CAAC,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,GAAA,CAAC,CAAC;QAErD,KAAK,CAAC,MAAM,CAAC,KAAK,KAAK,CAAC,CAAC,GAAG,KAAK,CAAC,MAAM,GAAG,KAAK,EAAE,CAAC,EAAE,IAAI,CAAC,CAAC;QAE3D,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE;YACtB,mBAAmB,EAAE,CAAC;YACtB,aAAa,EAAE,CAAC;SACjB;QACD,iBAAiB,EAAE,CAAC;IACtB,CAAC;AAED,aAAgB,KAAK;QACnB,KAAK,CAAC,OAAO,CAAC,UAAC,IAAI,EAAE,CAAC;YACpB,IAAM,KAAK,GAAG,CAAC,GAAG,CAAC,GAAG,KAAK,GAAG,MAAM,CAAC;YACrC,IAAM,MAAM,GAAG,gBAAc,KAAO,CAAC;YACrC,IAAM,QAAQ,GAAG,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YAC/C,IAAM,GAAG,GAAG;gBACV,UAAQ,IAAI,CAAC,GAAG,MAAG;gBACnB,cAAc;gBACd,qBAAqB;gBACrB,iBAAe,MAAM,MAAG;aACzB,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;YAEX,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,GAAG,MAAM,CAAC;YAE9B,QAAQ,CAAC,SAAS,GAAG,YAAY,CAAC;YAClC,QAAQ,CAAC,YAAY,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;YACpC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;SACrC,CAAC,CAAC;QACH,OAAO,KAAK,CAAC;IACf,CAAC;IAED,SAAS,QAAQ,CAAC,QAA2B;QAC3C,IAAI,IAAI,GAAG,IAAI,CAAC;QAChB,OAAO;YACL,IAAI,IAAI,EAAE;gBACR,QAAQ,EAAE,CAAC;gBACX,IAAI,GAAG,KAAK,CAAC;gBACb,UAAU,CAAC,cAAM,QAAC,IAAI,GAAG,IAAI,IAAC,EAAE,GAAG,CAAC,CAAC;aACtC;SACF,CAAC;IACJ,CAAC;IAED,SAAS,aAAa,CAAC,IAAmB;QACxC,IAAM,GAAG,GAAG,UAAU,EAAE,CAAC;QACzB,IAAM,WAAW,GAAG,IAAI,CAAC,EAAE,CAAC,qBAAqB,EAAE,CAAC;QACpD,OAAO,WAAW,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC;IACzD,CAAC;IAED,SAAS,UAAU;QACjB,IAAI,OAAO,WAAW,KAAK,WAAW,EAAE;YACtC,OAAO,WAAW,CAAC;SACpB;aAAM;YACL,IAAI,GAAG,GAAG,QAAQ,CAAC,eAAe,CAAC;YACnC,GAAG,GAAG,GAAG,CAAC,YAAY,GAAG,GAAG,GAAG,QAAQ,CAAC,IAAI,CAAC;YAC7C,OAAO,GAAG,CAAC,SAAS,CAAC;SACtB;IACH,CAAC;IAED,SAAS,QAAQ;IAMjB,CAAC;IAED,SAAS,QAAQ;QACf,mBAAmB,EAAE,CAAC;QACtB,iBAAiB,EAAE,CAAC;IACtB,CAAC;IAED,SAAS,aAAa;QACpB,MAAM,CAAC,gBAAgB,CAAC,QAAQ,EAAE,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;QACtD,MAAM,CAAC,gBAAgB,CAAC,QAAQ,EAAE,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;IACxD,CAAC;IAED,SAAS,aAAa;QACpB,MAAM,CAAC,mBAAmB,CAAC,QAAQ,EAAE,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;QACzD,MAAM,CAAC,mBAAmB,CAAC,QAAQ,EAAE,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;IAC3D,CAAC;IAED,SAAS,oBAAoB;QAC3B,SAAS,GAAG,MAAM,CAAC,WAAW,CAAC;QAC/B,KAAmB,UAAK,EAAL,eAAK,EAAL,mBAAK,EAAL,IAAK,EAAE;YAArB,IAAM,IAAI,cAAA;YACb,IAAI,CAAC,GAAG,GAAG,aAAa,CAAC,IAAI,CAAC,CAAC;SAChC;QACD,iBAAiB,EAAE,CAAC;IACtB,CAAC;IAED,SAAS,mBAAmB;QAC1B,SAAS,GAAG,MAAM,CAAC,WAAW,CAAC;QAC/B,SAAS,GAAG,QAAQ,CAAC,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC;IAC7D,CAAC;IAED,SAAS,mBAAmB;QAC1B,IAAM,gBAAgB,GAAG,QAAQ,CAAC,IAAI,CAAC,YAAY,CAAC;QACpD,IAAI,SAAS,KAAK,gBAAgB,EAAE;YAClC,SAAS,GAAG,gBAAgB,CAAC;YAC7B,oBAAoB,EAAE,CAAC;SACxB;IACH,CAAC;IAED,SAAS,iBAAiB;QACxB,IAAM,UAAU,GAAG,UAAU,EAAE,CAAC;QAChC,IAAM,gBAAgB,GAAG,SAAS,GAAG,UAAU,CAAC;QAChD,KAAmB,UAAK,EAAL,eAAK,EAAL,mBAAK,EAAL,IAAK,EAAE;YAArB,IAAM,IAAI,cAAA;YACb,IAAI,gBAAgB,IAAI,IAAI,CAAC,GAAG,EAAE;gBAChC,IAAI,IAAI,CAAC,QAAQ,EAAE;oBACjB,IAAI,CAAC,QAAQ,EAAE,CAAC;iBACjB;gBACD,KAAK,CAAC,KAAK,EAAE,CAAC;aACf;iBAAM;gBACL,MAAM;aACP;SACF;QACD,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE;YACjB,aAAa,EAAE,CAAC;SACjB;IACH,CAAC;;;;;;;;;;;;;;;"}